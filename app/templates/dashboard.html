{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="nav">
    <div class="title" style="margin: 0;">Link Manager</div>
    <div>
        <span style="color: #6b7280; margin-right: 1rem;">
            {{ user.username }} 
            {% if user.is_admin %}<span style="background: #fbbf24; color: #78350f; padding: 2px 6px; border-radius: 999px; font-size: 0.7rem; font-weight: bold; vertical-align: middle;">ADMIN</span>{% endif %}
        </span>
        <a href="/logout">Logout</a>
    </div>
</div>

{% if user.is_admin %}
<div class="card">
    <h3 class="title" style="font-size: 1rem;">Admin Filters</h3>
    <form method="get" action="/dashboard" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="filter_user">Filter by User</label>
            <select name="filter_user" id="filter_user" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; min-width: 150px;">
                <option value="">All Users</option>
                {% for u in all_users %}
                <option value="{{ u.username }}" {% if filter_user == u.username %}selected{% endif %}>{{ u.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
             <label for="filter_date">Filter by Date</label>
             <input type="date" name="filter_date" id="filter_date" value="{{ filter_date if filter_date else '' }}" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>
        <button type="submit" class="btn">Filter</button>
        {% if filter_user or filter_date %}
        <a href="/dashboard" class="btn" style="background-color: #6b7280;">Clear</a>
        {% endif %}
    </form>
</div>
{% endif %}

<div class="card">
    <h2 class="title" style="font-size: 1.25rem;">Create New Link</h2>
    
    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}
    
    <form method="post" action="/links/create" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
        <div class="form-group" style="flex: 2; margin-bottom: 0;">
            <label for="target_url">Target URL</label>
            <input 
                type="text" 
                id="target_url" 
                name="target_url" 
                placeholder="https://example.com/very-long-url" 
                required
                value="{{ last_url if last_url else '' }}"
            >
        </div>
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label for="slug">Custom Slug (Optional)</label>
            <input type="text" id="slug" name="slug" placeholder="custom-slug">
        </div>
        <button type="submit" class="btn">Shorten</button>
    </form>
</div>

<div class="card">
    <h2 class="title" style="font-size: 1.25rem;">Your Links</h2>
    {% if links %}
        <table class="table">
            <thead>
                <tr>
                    <th>Short Link</th>
                    <th>Destination</th>
                    <th>Clicks</th>
                    <th>Created</th>
                    <th>Created By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for link in links %}
                <tr>
                    <td>
                        <a href="/{{ link.slug }}" target="_blank" style="color: #2563eb; font-weight: 500;">
                            /{{ link.slug }}
                        </a>
                    </td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        <a href="{{ link.target_url }}" target="_blank" style="color: #4b5563;">
                            {{ link.target_url }}
                        </a>
                    </td>
                    <td>{{ link.click_count }}</td>
                    <td>{{ link.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>{{ link.owner.username }}</td>
                    <td>
                        <a href="/links/{{ link.slug }}/qrcode" class="btn" style="background-color: #10b981; font-size: 0.8rem; padding: 0.25rem 0.5rem; margin-right: 0.5rem;" target="_blank">QR Code</a>
                        <a href="/links/{{ link.id }}/delete" class="btn btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="color: #6b7280; text-align: center; padding: 1rem;">No links created yet.</p>
    {% endif %}
</div>
{% endblock %}
